import base64
import json
from pprint import pprint
from time import sleep
from config import key, secret, passphrase
import cbpro
import csv

encoded = json.dumps(secret).encode()
b64secret = base64.b64encode(encoded)
auth_client = cbpro.AuthenticatedClient(key=key, b64secret=secret, passphrase=passphrase,
                                        api_url="https://api.exchange.coinbase.com")
try:
    d = auth_client.get_fills(product_id='BTC-USD', )
    data_file = open('../data_file.csv', 'w')
    csv_writer = csv.writer(data_file)

    count = 0
    while True:
        try:
            data = d.next()
            if count == 0:
                count += 1
                header = data.keys()
                csv_writer.writerow(header)
            csv_writer.writerow(data.values())
        except StopIteration:
            break

except Exception as e:
    print('Error obtaining ticker data: ' + str(e))

